name: Docker Multi-Arch CI

on:
  # 1. åœ¨åˆ›å»ºreleaseæ—¶è‡ªåŠ¨è§¦å‘
  release:
    types: [created]
  
  # 2. æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Dockeré•œåƒæ ‡ç­¾ (é»˜è®¤: latest)'
        required: false
        default: 'latest'
        type: string
      push_to_registry:
        description: 'æ˜¯å¦æ¨é€åˆ°Docker Hub'
        required: false
        default: true
        type: boolean
      build_platforms:
        description: 'æ„å»ºå¹³å°æ¶æ„'
        required: false
        default: 'linux/amd64,linux/arm64'
        type: string
        options:
          - linux/amd64
          - linux/arm64
          - linux/amd64,linux/arm64
      enable_manifest_list:
        description: 'æ˜¯å¦åˆ›å»ºå¤šæ¶æ„manifestæ¸…å•'
        required: false
        default: true
        type: boolean

# å®šä¹‰ç¯å¢ƒå˜é‡
env:
  REGISTRY: docker.io
  IMAGE_NAME: 2799214854/edgeone-dynamic-origin
  DOCKER_BUILDKIT: 1

jobs:
  build:
    runs-on: ubuntu-latest
    
    # æ ¹æ®è§¦å‘æ–¹å¼é€‰æ‹©ç¯å¢ƒ
    environment: ${{ github.event_name == 'workflow_dispatch' && 'staging' || 'production' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ï¼Œæœ‰åŠ©äºDockerç¼“å­˜

    - name: Determine build parameters
      id: vars
      run: |
        # æ ¹æ®è§¦å‘æ–¹å¼ç¡®å®šæ ‡ç­¾
        if [ "${{ github.event_name }}" = "release" ]; then
          echo "trigger_type=release"
          echo "image_tag=${{ github.ref_name }}"
          echo "create_latest=true"
          echo "push_images=true"
        elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "trigger_type=manual"
          echo "image_tag=${{ github.event.inputs.tag_name }}"
          echo "create_latest=${{ github.event.inputs.enable_manifest_list }}"
          echo "push_images=${{ github.event.inputs.push_to_registry }}"
        else
          echo "trigger_type=other"
          echo "image_tag=dev"
          echo "create_latest=false"
          echo "push_images=true"
        fi
        
        # æå–çŸ­æäº¤ID
        echo "git_sha_short=$(git rev-parse --short HEAD)" 
        
        # è®¾ç½®å¹³å°
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "build_platforms=${{ github.event.inputs.build_platforms }}"
        else
          echo "build_platforms=linux/amd64,linux/arm64"
        fi
        
        # å½“å‰æ—¶é—´æˆ³
        echo "timestamp=$(date -u +'%Y%m%d%H%M%S')"
        
        # ç”Ÿæˆå®Œæ•´æ ‡ç­¾
        if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.tag_name }}" = "latest" ]; then
          echo "full_tag=$IMAGE_NAME:latest"
        elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "full_tag=$IMAGE_NAME:${{ github.event.inputs.tag_name }}-$(git rev-parse --short HEAD)"
        elif [ "${{ github.event_name }}" = "release" ]; then
          echo "full_tag=$IMAGE_NAME:${{ github.ref_name }}"
        else
          echo "full_tag=$IMAGE_NAME:dev-$(git rev-parse --short HEAD)"
        fi
        
        # è¾“å‡ºå˜é‡
        echo "trigger_type=$trigger_type" >> $GITHUB_OUTPUT
        echo "image_tag=$image_tag" >> $GITHUB_OUTPUT
        echo "create_latest=$create_latest" >> $GITHUB_OUTPUT
        echo "push_images=$push_images" >> $GITHUB_OUTPUT
        echo "git_sha_short=$git_sha_short" >> $GITHUB_OUTPUT
        echo "build_platforms=$build_platforms" >> $GITHUB_OUTPUT
        echo "timestamp=$timestamp" >> $GITHUB_OUTPUT
        echo "full_tag=$full_tag" >> $GITHUB_OUTPUT
      env:
        IMAGE_NAME: ${{ env.IMAGE_NAME }}

    - name: Log build parameters
      run: |
        echo "ğŸ“‹ æ„å»ºå‚æ•°:"
        echo "è§¦å‘æ–¹å¼: ${{ steps.vars.outputs.trigger_type }}"
        echo "é•œåƒæ ‡ç­¾: ${{ steps.vars.outputs.full_tag }}"
        echo "Gitæäº¤: ${{ steps.vars.outputs.git_sha_short }}"
        echo "æ„å»ºå¹³å°: ${{ steps.vars.outputs.build_platforms }}"
        echo "æ¨é€é•œåƒ: ${{ steps.vars.outputs.push_images }}"
        echo "åˆ›å»ºlatestæ ‡ç­¾: ${{ steps.vars.outputs.create_latest }}"
        echo "æ—¶é—´æˆ³: ${{ steps.vars.outputs.timestamp }}"

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: ${{ fromJSON(format('["{0}"]', replace(steps.vars.outputs.build_platforms, ',', '","'))) }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver: docker-container
        driver-opts: |
          image=moby/buildkit:latest
        platforms: ${{ steps.vars.outputs.build_platforms }}
        install: true
        use: true
        config-inline: |
          [registry."${{ env.REGISTRY }}"]
            http = true
            insecure = false

    - name: Extract metadata for Docker
      id: meta
      run: |
        # ä¸ºæ ‡ç­¾æå–å…ƒæ•°æ®
        echo "ref_name=$(echo "${GITHUB_REF#refs/tags/}" || echo "manual-${GITHUB_SHA:0:7}")" >> $GITHUB_OUTPUT
        echo "sha_short=${{ steps.vars.outputs.git_sha_short }}" >> $GITHUB_OUTPUT
        echo "date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
        echo "build_number=${GITHUB_RUN_ID}" >> $GITHUB_OUTPUT
        echo "version=${{ steps.vars.outputs.image_tag }}" >> $GITHUB_OUTPUT

    - name: Log in to Docker Hub
      if: steps.vars.outputs.push_images == 'true'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Prepare tags
      id: tags
      run: |
        # å‡†å¤‡æ ‡ç­¾åˆ—è¡¨
        tags="${{ steps.vars.outputs.full_tag }}"
        
        # å¦‚æœéœ€è¦æ·»åŠ latestæ ‡ç­¾
        if [ "${{ steps.vars.outputs.create_latest }}" = "true" ] && [ "${{ steps.vars.outputs.trigger_type }}" = "release" ]; then
          tags="$tags,$IMAGE_NAME:latest"
        fi
        
        # è¾“å‡ºæ ‡ç­¾
        echo "tags=$tags" >> $GITHUB_OUTPUT
        echo "ğŸ”– ç”Ÿæˆçš„æ ‡ç­¾: $tags"
      env:
        IMAGE_NAME: ${{ env.IMAGE_NAME }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: ${{ steps.vars.outputs.build_platforms }}
        push: ${{ steps.vars.outputs.push_images == 'true' }}
        tags: ${{ steps.tags.outputs.tags }}
        labels: |
          org.opencontainers.image.title=edgeone-dynamic-origin
          org.opencontainers.image.description=EdgeOne Dynamic Origin
          org.opencontainers.image.url=https://github.com/${{ github.repository }}
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.version=${{ steps.meta.outputs.version }}
          org.opencontainers.image.created=${{ steps.meta.outputs.date }}
          org.opencontainers.image.revision=${{ github.sha }}
          org.opencontainers.image.vendor=${{ github.actor }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        provenance: false
        outputs: |
          type=registry,
          name=${{ env.IMAGE_NAME }},
          push=${{ steps.vars.outputs.push_images == 'true' }}

    - name: Verify pushed images
      if: steps.vars.outputs.push_images == 'true' && success()
      run: |
        echo "ğŸ” éªŒè¯æ¨é€çš„é•œåƒ..."
        
        # ç™»å½•Docker HubæŸ¥çœ‹manifest
        echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
        
        # æ£€æŸ¥æ¯ä¸ªæ ‡ç­¾
        IFS=',' read -ra TAG_ARRAY <<< "${{ steps.tags.outputs.tags }}"
        for tag in "${TAG_ARRAY[@]}"; do
          echo "æ£€æŸ¥æ ‡ç­¾: $tag"
          docker buildx imagetools inspect "$tag" || echo "âš ï¸  æ— æ³•æ£€æŸ¥ $tag"
        done
        
        docker logout
        
        echo "âœ… é•œåƒæ¨é€å®Œæˆ!"
        echo "ğŸ“¦ é•œåƒæ ‡ç­¾: ${{ steps.tags.outputs.tags }}"
        echo "ğŸ—ï¸  æ„å»ºå¹³å°: ${{ steps.vars.outputs.build_platforms }}"

    - name: Build summary
      if: always()
      run: |
        echo "ğŸ“Š æ„å»ºæ€»ç»“"
        echo "========================================"
        echo "å·¥ä½œæµ: ${{ github.workflow }}"
        echo "è¿è¡ŒID: ${{ github.run_id }}"
        echo "è§¦å‘æ–¹å¼: ${{ steps.vars.outputs.trigger_type }}"
        echo "æäº¤: ${{ github.sha }}"
        echo "åˆ†æ”¯/æ ‡ç­¾: ${{ github.ref }}"
        echo "é•œåƒåç§°: ${{ env.IMAGE_NAME }}"
        echo "é•œåƒæ ‡ç­¾: ${{ steps.tags.outputs.tags }}"
        echo "æ„å»ºå¹³å°: ${{ steps.vars.outputs.build_platforms }}"
        echo "æ¨é€çŠ¶æ€: ${{ steps.vars.outputs.push_images == 'true' && 'å·²æ¨é€' || 'æœªæ¨é€' }}"
        echo "åˆ›å»ºæ—¶é—´: $(date)"
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… æ„å»ºæˆåŠŸ!"
          if [ "${{ steps.vars.outputs.push_images }}" = "true" ]; then
            echo "ğŸŒ æŸ¥çœ‹é•œåƒ: https://hub.docker.com/r/${{ env.IMAGE_NAME }}/tags"
          fi
        else
          echo "âŒ æ„å»ºå¤±è´¥!"
        fi
        echo "========================================"

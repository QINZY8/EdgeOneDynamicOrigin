name: Docker Multi-Arch CI

on:
  # 1. åœ¨åˆ›å»ºreleaseæ—¶è‡ªåŠ¨è§¦å‘
  release:
    types: [created]
  
  # 2. æ”¯æŒæ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Dockeré•œåƒæ ‡ç­¾'
        required: false
        default: 'manual-${GITHUB_SHA:0:7}'
        type: string
      push_to_registry:
        description: 'æ˜¯å¦æ¨é€åˆ°Docker Hub'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      build_platforms:
        description: 'æ„å»ºå¹³å°æ¶æ„'
        required: false
        default: 'linux/amd64,linux/arm64'
        type: string
      create_latest:
        description: 'æ˜¯å¦åˆ›å»ºlatestæ ‡ç­¾'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

# å®šä¹‰ç¯å¢ƒå˜é‡
env:
  REGISTRY: docker.io
  IMAGE_NAME: 2799214854/edgeone-dynamic-origin
  DOCKER_BUILDKIT: 1

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    # æ ¹æ®è§¦å‘æ–¹å¼é€‰æ‹©ç¯å¢ƒ
    environment: ${{ github.event_name == 'workflow_dispatch' && 'staging' || 'production' }}
    
    steps:
    - name: æ£€æŸ¥å·¥ä½œæµè§¦å‘çŠ¶æ€
      run: |
        echo "GitHub Event Name: ${{ github.event_name }}"
        echo "GitHub Ref: ${{ github.ref }}"
        echo "GitHub Ref Name: ${{ github.ref_name }}"
        echo "GitHub SHA: ${{ github.sha }}"
        echo "å·¥ä½œæµè¢«è§¦å‘!"
        
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ï¼Œæœ‰åŠ©äºDockerç¼“å­˜

    - name: ç¡®å®šæ„å»ºå‚æ•°
      id: vars
      run: |
        echo "=== æ„å»ºå‚æ•°é…ç½® ==="
        
        # è®¾ç½®é»˜è®¤æ ‡ç­¾
        if [ "${{ github.event_name }}" = "release" ]; then
          TAG_NAME="${{ github.ref_name }}"
          echo "è§¦å‘æ–¹å¼: release"
          echo "ä½¿ç”¨releaseæ ‡ç­¾: $TAG_NAME"
        else
          # å¤„ç†æ‰‹åŠ¨è§¦å‘
          TAG_NAME="${{ github.event.inputs.tag_name }}"
          echo "è§¦å‘æ–¹å¼: workflow_dispatch"
          echo "è¾“å…¥æ ‡ç­¾: $TAG_NAME"
        fi
        
        # å¦‚æœæ ‡ç­¾ä¸ºç©ºæˆ–ä¸ºé»˜è®¤å€¼ï¼Œæ·»åŠ æäº¤ID
        if [[ "$TAG_NAME" == "manual-${GITHUB_SHA:0:7}" ]] || [[ -z "$TAG_NAME" ]]; then
          SHORT_SHA=$(git rev-parse --short HEAD)
          FINAL_TAG="manual-$SHORT_SHA"
        elif [[ "$TAG_NAME" == "latest" ]]; then
          FINAL_TAG="latest"
        else
          FINAL_TAG="$TAG_NAME"
        fi
        
        echo "æœ€ç»ˆé•œåƒæ ‡ç­¾: $FINAL_TAG"
        echo "image_tag=$FINAL_TAG" >> $GITHUB_OUTPUT
        
        # æ¨é€è®¾ç½®
        if [ "${{ github.event_name }}" = "release" ]; then
          PUSH_IMAGES="true"
          echo "releaseè§¦å‘: æ¨é€é•œåƒåˆ°ä»“åº“"
        else
          PUSH_IMAGES="${{ github.event.inputs.push_to_registry }}"
          echo "æ‰‹åŠ¨è§¦å‘: æ¨é€é•œåƒ = $PUSH_IMAGES"
        fi
        
        echo "push_images=$PUSH_IMAGES" >> $GITHUB_OUTPUT
        
        # å¹³å°è®¾ç½®
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          PLATFORMS="${{ github.event.inputs.build_platforms }}"
        else
          PLATFORMS="linux/amd64,linux/arm64"
        fi
        echo "build_platforms=$PLATFORMS" >> $GITHUB_OUTPUT
        
        # latestæ ‡ç­¾è®¾ç½®
        if [ "${{ github.event_name }}" = "release" ]; then
          CREATE_LATEST="true"
        elif [ "${{ github.event.name }}" = "workflow_dispatch" ]; then
          CREATE_LATEST="${{ github.event.inputs.create_latest }}"
        else
          CREATE_LATEST="false"
        fi
        echo "create_latest=$CREATE_LATEST" >> $GITHUB_OUTPUT
        
        echo "å¹³å°: $PLATFORMS"
        echo "åˆ›å»ºlatestæ ‡ç­¾: $CREATE_LATEST"
        echo "=== å‚æ•°é…ç½®å®Œæˆ ==="

    - name: Log build parameters
      run: |
        echo "ğŸ“‹ æœ€ç»ˆæ„å»ºå‚æ•°:"
        echo "é•œåƒæ ‡ç­¾: ${{ steps.vars.outputs.image_tag }}"
        echo "æ„å»ºå¹³å°: ${{ steps.vars.outputs.build_platforms }}"
        echo "æ¨é€é•œåƒ: ${{ steps.vars.outputs.push_images }}"
        echo "åˆ›å»ºlatestæ ‡ç­¾: ${{ steps.vars.outputs.create_latest }}"

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: |
          arm64
          amd64

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver: docker-container
        driver-opts: |
          image=moby/buildkit:latest
        platforms: ${{ steps.vars.outputs.build_platforms }}
        install: true
        use: true

    - name: ç™»å½•Docker Hub
      if: steps.vars.outputs.push_images == 'true'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: å‡†å¤‡Dockeræ ‡ç­¾
      id: docker-tags
      run: |
        TAGS="${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.image_tag }}"
        
        # å¦‚æœéœ€è¦æ·»åŠ latestæ ‡ç­¾
        if [ "${{ steps.vars.outputs.create_latest }}" = "true" ]; then
          TAGS="$TAGS,${{ env.IMAGE_NAME }}:latest"
          echo "âœ… æ·»åŠ latestæ ‡ç­¾"
        fi
        
        echo "æœ€ç»ˆDockeræ ‡ç­¾: $TAGS"
        echo "tags=$TAGS" >> $GITHUB_OUTPUT

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: ${{ steps.vars.outputs.build_platforms }}
        push: ${{ steps.vars.outputs.push_images == 'true' }}
        tags: ${{ steps.docker-tags.outputs.tags }}
        labels: |
          org.opencontainers.image.title=edgeone-dynamic-origin
          org.opencontainers.image.description=EdgeOne Dynamic Origin
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.version=${{ steps.vars.outputs.image_tag }}
          org.opencontainers.image.created=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
          org.opencontainers.image.revision=${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        provenance: false

    - name: éªŒè¯æ¨é€çš„é•œåƒ
      if: steps.vars.outputs.push_images == 'true' && success()
      run: |
        echo "ğŸ” éªŒè¯æ¨é€çš„é•œåƒ..."
        
        # æ£€æŸ¥æ¯ä¸ªæ ‡ç­¾
        IFS=',' read -ra TAG_ARRAY <<< "${{ steps.docker-tags.outputs.tags }}"
        for tag in "${TAG_ARRAY[@]}"; do
          echo "âœ… é•œåƒå·²æ¨é€: $tag"
        done
        
        echo "âœ… é•œåƒæ¨é€å®Œæˆ!"
        echo "ğŸ“¦ é•œåƒä»“åº“: https://hub.docker.com/r/${{ env.IMAGE_NAME }}"

    - name: Build summary
      if: always()
      run: |
        echo ""
        echo "ğŸ“Š æ„å»ºæ€»ç»“"
        echo "========================================"
        echo "å·¥ä½œæµ: ${{ github.workflow }}"
        echo "è¿è¡ŒID: ${{ github.run_id }}"
        echo "è¿è¡Œç¼–å·: ${{ github.run_number }}"
        echo "æäº¤: ${{ github.sha }}"
        echo "åˆ†æ”¯/æ ‡ç­¾: ${{ github.ref }}"
        echo "é•œåƒåç§°: ${{ env.IMAGE_NAME }}"
        echo "é•œåƒæ ‡ç­¾: ${{ steps.docker-tags.outputs.tags }}"
        echo "æ„å»ºå¹³å°: ${{ steps.vars.outputs.build_platforms }}"
        echo "æ¨é€çŠ¶æ€: ${{ steps.vars.outputs.push_images == 'true' && 'å·²æ¨é€' || 'æœªæ¨é€' }}"
        echo "æ„å»ºæ—¶é—´: $(date)"
        echo "========================================"
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "âœ… æ„å»ºæˆåŠŸ!"
          echo ""
          if [ "${{ steps.vars.outputs.push_images }}" = "true" ]; then
            echo "ğŸŒ Docker Hubåœ°å€: https://hub.docker.com/r/${{ env.IMAGE_NAME }}"
            echo ""
            IFS=',' read -ra TAG_ARRAY <<< "${{ steps.docker-tags.outputs.tags }}"
            for tag in "${TAG_ARRAY[@]}"; do
              echo "ğŸ“¦ $tag"
            done
          fi
        else
          echo "âŒ æ„å»ºå¤±è´¥!"
          echo "è¯·æ£€æŸ¥æ—¥å¿—è·å–è¯¦ç»†ä¿¡æ¯"
        fi
        echo "========================================"

name: Docker Multi-Arch CI

on:
  release:
    types: [created]

# å®šä¹‰ç¯å¢ƒå˜é‡
env:
  REGISTRY: docker.io
  IMAGE_NAME: 2799214854/edgeone-dynamic-origin

jobs:
  build:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ï¼Œæœ‰åŠ©äºDockerç¼“å­˜

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3
      with:
        platforms: arm64,amd64  # æ˜ç¡®æŒ‡å®šæ¶æ„

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
      with:
        driver: docker-container
        driver-opts: |
          image=moby/buildkit:latest
        platforms: linux/amd64,linux/arm64
        install: true
        use: true

    - name: Extract metadata for Docker
      id: meta
      run: |
        # ä¸ºæ ‡ç­¾æå–å…ƒæ•°æ®
        echo "ref_name=$(echo "${GITHUB_REF#refs/tags/}")" >> $GITHUB_OUTPUT
        echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
        echo "date=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
        echo "build_number=${GITHUB_RUN_ID}" >> $GITHUB_OUTPUT

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          ${{ env.IMAGE_NAME }}:${{ github.ref_name }}
          ${{ env.IMAGE_NAME }}:latest
        labels: |
          org.opencontainers.image.title=edgeone-dynamic-origin
          org.opencontainers.image.description=EdgeOne Dynamic Origin
          org.opencontainers.image.url=https://github.com/${{ github.repository }}
          org.opencontainers.image.source=https://github.com/${{ github.repository }}
          org.opencontainers.image.version=${{ github.ref_name }}
          org.opencontainers.image.created=${{ steps.meta.outputs.date }}
          org.opencontainers.image.revision=${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        provenance: false  # å¤šæ¶æ„æ„å»ºæ—¶å¯èƒ½éœ€è¦ç¦ç”¨

    - name: Verify pushed images
      run: |
        # éªŒè¯é•œåƒæ˜¯å¦æˆåŠŸæ¨é€
        echo "Verifying pushed images..."
        
        # æ£€æŸ¥ç‰¹å®šæ¶æ„çš„manifest
        docker buildx imagetools inspect ${{ env.IMAGE_NAME }}:${{ github.ref_name }}
        
        echo "âœ… Images successfully pushed for:"
        echo "- ${{ env.IMAGE_NAME }}:${{ github.ref_name }}"
        echo "- ${{ env.IMAGE_NAME }}:latest"
        echo "ğŸ“¦ Architectures: linux/amd64, linux/arm64"

    - name: Notify on success
      if: success()
      run: |
        echo "ğŸ‰ Docker multi-arch build completed successfully!"
        echo "Release: ${{ github.ref_name }}"
        echo "Run ID: ${{ github.run_id }}"
        echo "See images at: https://hub.docker.com/r/${{ env.IMAGE_NAME }}/tags"

    - name: Notify on failure
      if: failure()
      run: |
        echo "âŒ Docker multi-arch build failed!"
        echo "Please check the logs for details."
        exit 1
